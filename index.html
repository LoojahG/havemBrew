<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Haven Brew</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CryptoJS for HMAC -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f8f8f8;
        }

        .cart-drawer {
            transition: transform 0.3s ease-out;
            transform: translateX(100%);
        }

        .cart-drawer.open {
            transform: translateX(0);
        }
    </style>
</head>

<body class="min-h-screen">

    <!-- Header -->
    <header class="bg-slate-900 shadow-lg sticky top-0 z-10">
        <div class="container mx-auto p-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-amber-400">Haven Brew</a>
            <nav class="flex items-center space-x-6 text-white">
                <a href="#" class="text-amber-400 font-semibold">Home</a>
                <a href="about.html" class="hover:text-amber-400">About</a>
                <button id="openCartBtn"
                    class="p-2 bg-amber-400 text-slate-900 rounded-lg hover:bg-amber-500 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cartCount" class="ml-2 font-semibold">0</span>
                </button>
            </nav>
        </div>
    </header>

    <!-- Main -->
    <main class="container mx-auto p-6">
        <h2 class="text-4xl font-extrabold text-slate-800 mb-8 text-center">Our Products</h2>
        <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    </main>

    <!-- Cart Drawer -->
    <div id="cartDrawer"
        class="cart-drawer fixed top-0 right-0 w-full sm:w-96 h-full bg-white shadow-2xl z-20 flex flex-col p-6">
        <div class="flex justify-between items-center border-b pb-4 mb-4">
            <h3 class="text-2xl font-bold text-slate-800">Your Cart</h3>
            <button id="closeCartBtn" class="text-slate-500 hover:text-slate-900 p-1 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div id="cartItemsList" class="flex-grow overflow-y-auto space-y-4"></div>
        <p id="emptyCartMessage" class="text-center text-slate-500 hidden">
            Your cart is empty. Add some coffee!
        </p>

        <div id="cartSummary" class="mt-6 pt-4 border-t">
            <div class="flex justify-between text-xl font-semibold mb-2 text-slate-800">
                <span>Subtotal:</span>
                <span id="cartSubtotal">रु 0.00</span>
            </div>
            <button id="checkoutBtn"
                class="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors disabled:bg-slate-400 flex items-center justify-center space-x-2"
                disabled>
                <span>Pay with eSewa</span>
                <!-- <img src="https://esewa.com.np/common/images/esewa_logo_dark.png" class="h-5" alt="eSewa Logo"> -->
            </button>
        </div>
    </div>

    <!-- Backdrop -->
    <div id="cartBackdrop" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden" onclick="toggleCart(false)"></div>

    <footer class="bg-slate-900 text-white text-center py-6 mt-12">
        <p class="text-sm">&copy; 2025 Haven Brew. All rights reserved.</p>
    </footer>

    <script>
        const products = [
            { id: 1, name: "Premium Coffee Beans (1kg)", price: 1500, image: "https://tse3.mm.bing.net/th/id/OIP.EdfNyU32ADhVnVoM1zDYzwHaF7" },
            { id: 2, name: "Ceramic Mug Set (4 pcs)", price: 2000, image: "https://theculinarium.co.za/cdn/shop/products/George_Mason-4XMUGS.jpg?v=1671786974" },
            { id: 3, name: "French Press Maker (Large)", price: 8000, image: "https://bing.com/th?id=OSK.51366f7b89cb07b21919f19d48df1b15" },
            { id: 4, name: "Espresso Tamper", price: 3000, image: "https://th.bing.com/th/id/OIP.762ZdmBzOi7CM3VQl5WyDwHaGQ" },
            { id: 5, name: "Manual Coffee Grinder", price: 4500, image: "https://tse3.mm.bing.net/th/id/OIP.RGrLXiGnJjhR6sDAejbHkwHaJg" },
            { id: 6, name: "Coffee Storage Jar (Airtight)", price: 2500, image: "https://m.media-amazon.com/images/I/616odNZ63nL._AC_SL1500_.jpg" }
        ];

        let cart = [];

        const cartDrawer = document.getElementById("cartDrawer");
        const cartBackdrop = document.getElementById("cartBackdrop");
        const openCartBtn = document.getElementById("openCartBtn");
        const closeCartBtn = document.getElementById("closeCartBtn");
        const cartCount = document.getElementById("cartCount");
        const cartSubtotal = document.getElementById("cartSubtotal");
        const cartItemsList = document.getElementById("cartItemsList");
        const checkoutBtn = document.getElementById("checkoutBtn");
        const emptyCartMessage = document.getElementById("emptyCartMessage");

        const formatCurrency = (amt) => `रु ${amt.toFixed(2)}`;
        const getSubtotal = () => cart.reduce((s, i) => s + i.price * i.quantity, 0);

        function toggleCart(open) {
            if (open) {
                cartDrawer.classList.add("open");
                cartBackdrop.classList.remove("hidden");
                document.body.style.overflow = "hidden";
            } else {
                cartDrawer.classList.remove("open");
                cartBackdrop.classList.add("hidden");
                document.body.style.overflow = "";
            }
        }

        function updateCart() {
            const subtotal = getSubtotal();
            cartSubtotal.textContent = formatCurrency(subtotal);
            cartCount.textContent = cart.reduce((s, i) => s + i.quantity, 0);
            cartItemsList.innerHTML = "";

            if (cart.length === 0) {
                emptyCartMessage.classList.remove("hidden");
                checkoutBtn.disabled = true;
            } else {
                emptyCartMessage.classList.add("hidden");
                checkoutBtn.disabled = false;
                cart.forEach((item) => {
                    const div = document.createElement("div");
                    div.className = "flex items-center space-x-4 bg-slate-100 p-3 rounded";
                    div.innerHTML = `
            <img src="${item.image}" class="w-14 h-14 object-cover rounded" alt="">
            <div class="flex-grow">
              <p class="font-semibold">${item.name}</p>
              <p class="text-slate-600">${formatCurrency(item.price)}</p>
            </div>
            <input type="number" min="1" value="${item.quantity}" data-id="${item.id}" class="w-14 border rounded text-center">
            <button data-id="${item.id}" class="text-red-500 font-bold">✕</button>
          `;
                    div.querySelector("input").addEventListener("change", (e) => {
                        const itemObj = cart.find((x) => x.id === item.id);
                        itemObj.quantity = Math.max(1, +e.target.value);
                        updateCart();
                    });
                    div.querySelector("button").addEventListener("click", () => {
                        cart = cart.filter((x) => x.id !== item.id);
                        updateCart();
                    });
                    cartItemsList.appendChild(div);
                });
            }
        }

        function addToCart(id) {
            const prod = products.find((p) => p.id === id);
            const exist = cart.find((c) => c.id === id);
            if (exist) exist.quantity++;
            else cart.push({ ...prod, quantity: 1 });
            updateCart();
        }

        function checkoutAndPayWithEsewa() {
            const secretKey = "8gBm/:&EnhH.1/q"; // sandbox secret key
            const totalFromCarts = getSubtotal();

            const now = new Date();
            const transactionUUID = "E-" + now.getFullYear() + (now.getMonth() + 1) + now.getDate() +
                now.getHours() + now.getMinutes() + now.getSeconds() + now.getMilliseconds();

            const taxAmount = 0;
            const serviceCharge = 0;
            const deliveryCharge = 0;
            const totalAmountWithCharge = totalFromCarts + taxAmount + serviceCharge + deliveryCharge;

            const signedFields = "total_amount,transaction_uuid,product_code";
            const productCode = "EPAYTEST";

            const signatureString = `total_amount=${totalAmountWithCharge},transaction_uuid=${transactionUUID},product_code=${productCode}`;
            const hash = CryptoJS.HmacSHA256(signatureString, secretKey);
            const signature = CryptoJS.enc.Base64.stringify(hash);

            const successUrl = "http://127.0.0.1:5500/success.html";
            const failureUrl = "http://127.0.0.1:5500/failure.html";

            const form = document.createElement("form");
            form.method = "POST";
            form.action = "https://rc-epay.esewa.com.np/api/epay/main/v2/form";

            const paymentData = {
                amount: totalFromCarts,
                tax_amount: taxAmount,
                total_amount: totalAmountWithCharge,
                transaction_uuid: transactionUUID,
                product_code: productCode,
                product_service_charge: serviceCharge,
                product_delivery_charge: deliveryCharge,
                success_url: successUrl,
                failure_url: failureUrl,
                signature: signature,
                signed_field_names: signedFields,
            };

            Object.entries(paymentData).forEach(([k, v]) => {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = k;
                input.value = v;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        }

        // Load products
        document.addEventListener("DOMContentLoaded", () => {
            const productGrid = document.getElementById("productGrid");
            products.forEach((p) => {
                const div = document.createElement("div");
                div.className = "bg-white p-6 rounded-xl shadow-lg flex flex-col";
                div.innerHTML = `
          <img src="${p.image}" class="h-48 w-full object-cover mb-4 rounded" alt="">
          <h3 class="text-xl font-bold mb-2">${p.name}</h3>
          <p class="text-2xl text-amber-500 font-semibold mb-4">${formatCurrency(p.price)}</p>
          <button class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 rounded"
                  data-id="${p.id}">Add to Cart</button>
        `;
                div.querySelector("button").addEventListener("click", () => {
                    addToCart(p.id);
                    toggleCart(true);
                });
                productGrid.appendChild(div);
            });

            openCartBtn.addEventListener("click", () => toggleCart(true));
            closeCartBtn.addEventListener("click", () => toggleCart(false));
            checkoutBtn.addEventListener("click", checkoutAndPayWithEsewa);
            updateCart();
        });
    </script>
</body>

</html>